<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Video Date ‚Äî HeyGen Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a; color: #fff; min-height: 100vh;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; padding: 20px;
        }
        h1 { font-size: 24px; margin-bottom: 8px; }
        .subtitle { color: #888; font-size: 14px; margin-bottom: 24px; }
        .badge {
            background: #1a1a2e; border: 1px solid #333; padding: 4px 12px;
            border-radius: 20px; font-size: 11px; color: #7c6ef6; margin-bottom: 20px;
        }
        .config { margin-bottom: 20px; text-align: center; }
        .config-row { margin-bottom: 10px; }
        .config label { color: #aaa; font-size: 13px; margin-right: 8px; }
        .config select {
            background: #1a1a1a; border: 1px solid #333; color: #fff;
            padding: 8px 12px; border-radius: 8px; font-size: 13px; width: 340px;
        }
        #start-btn {
            background: linear-gradient(135deg, #7c6ef6, #a855f7);
            border: none; color: #fff; font-size: 18px; font-weight: 600;
            padding: 16px 48px; border-radius: 50px; cursor: pointer;
            -webkit-tap-highlight-color: rgba(124,110,246,0.3);
            touch-action: manipulation;
            margin-bottom: 16px;
        }
        #start-btn:active { transform: scale(0.95); }
        #start-btn.disabled { opacity: 0.5; pointer-events: none; }
        #status { color: #aaa; font-size: 14px; margin-bottom: 8px; min-height: 20px; text-align: center; max-width: 400px; }
        #error-log { color: #f66; font-size: 12px; margin-bottom: 16px; max-width: 500px; text-align: center; word-break: break-all; min-height: 16px; }
        #video-container {
            width: 100%; max-width: 480px; background: #111;
            border-radius: 16px; overflow: hidden; display: none; position: relative;
        }
        #avatar-video { width: 100%; display: block; }
        .controls {
            display: none; gap: 12px; margin-top: 16px; align-items: center;
            flex-wrap: wrap; justify-content: center;
        }
        .controls button {
            background: #222; border: 1px solid #444; color: #fff;
            padding: 10px 20px; border-radius: 25px; cursor: pointer; font-size: 14px;
            touch-action: manipulation;
        }
        .end-btn:active { background: #ff4444 !important; }
        #chat-input {
            background: #1a1a1a; border: 1px solid #333; color: #fff;
            padding: 10px 16px; border-radius: 25px; font-size: 14px; width: 260px;
        }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #0f0; display: inline-block; animation: pulse 1s infinite; }
        @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }
        .tip { max-width: 500px; text-align: center; color: #555; font-size: 12px; margin-top: 16px; line-height: 1.5; }
    </style>
</head>
<body>
    <h1>üé• AI Video Date ‚Äî HeyGen</h1>
    <p class="subtitle">Real-time conversation with an AI avatar</p>
    <div class="badge">Powered by HeyGen Interactive Avatar + GPT-4o</div>

    <div class="config">
        <div class="config-row">
            <label>Avatar:</label>
            <select id="avatar-select">
                <option value="">ü§ñ Default HeyGen Avatar</option>
            </select>
        </div>
    </div>

    <button id="start-btn">Start Video Date üíï</button>
    <div id="status">Tap Start to begin</div>
    <div id="error-log"></div>

    <div id="video-container">
        <video id="avatar-video" autoplay playsinline></video>
    </div>

    <div class="controls" id="controls">
        <input type="text" id="chat-input" placeholder="Type something to say...">
        <button id="send-btn">Send üí¨</button>
        <button id="voice-btn">üéô Voice</button>
        <button class="end-btn" id="end-btn">End ‚úã</button>
    </div>

    <p class="tip">Type a message and Send ‚Äî the avatar speaks the AI response.<br>Or tap Voice for hands-free.</p>

    <!-- NO SDK ‚Äî pure vanilla JS -->
    <script>
        (function() {
            var API_KEY = 'sk_V2_hgu_kiKFJG7KJov_9vvKkvT4fFbndbtZvT7kliw6GsHzeEuS';
            var DATE_PROMPT = 'You are a fun, charming person on a first video date named Alex. Be warm, curious, flirty. Ask fun questions. Keep responses SHORT (2-3 sentences). Never mention you are AI. Start by introducing yourself.';

            var sessionId = null;
            var peerConnection = null;

            var statusEl = document.getElementById('status');
            var errorEl = document.getElementById('error-log');
            var startBtn = document.getElementById('start-btn');

            function log(msg) { statusEl.textContent = msg; console.log('[heygen] ' + msg); }
            function err(msg) { errorEl.textContent = msg; console.error('[heygen] ' + msg); }

            // ---- START BUTTON ----
            startBtn.addEventListener('click', function() {
                log('üîÑ Starting...');
                startBtn.classList.add('disabled');
                errorEl.textContent = '';
                startSession();
            });

            // Also handle touch for iOS
            startBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                startBtn.click();
            });

            async function startSession() {
                try {
                    // Step 1: Get token
                    log('üîÑ Getting session token...');
                    var tokenRes = await fetch('https://api.heygen.com/v1/streaming.create_token', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY }
                    });
                    var tokenData = await tokenRes.json();
                    console.log('Token response:', tokenData);

                    if (!tokenData.data || !tokenData.data.token) {
                        throw new Error('No token: ' + JSON.stringify(tokenData));
                    }
                    var token = tokenData.data.token;

                    // Step 2: Create streaming session via REST
                    log('üìû Creating avatar session...');
                    var avatarId = document.getElementById('avatar-select').value || undefined;

                    var sessionRes = await fetch('https://api.heygen.com/v1/streaming.new', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({
                            quality: 'high',
                            avatar_name: avatarId,
                            knowledge_base: DATE_PROMPT,
                            voice: { emotion: 'friendly' },
                            language: 'en',
                            version: 'v2'
                        })
                    });
                    var sessionData = await sessionRes.json();
                    console.log('Session response:', sessionData);

                    if (sessionData.code || sessionData.error) {
                        throw new Error('Session error: ' + (sessionData.message || sessionData.error || JSON.stringify(sessionData)));
                    }

                    var data = sessionData.data || sessionData;
                    sessionId = data.session_id;

                    if (!sessionId) {
                        throw new Error('No session_id in response');
                    }

                    // Step 3: Set up WebRTC
                    log('üîó Setting up video connection...');

                    if (data.url && data.access_token) {
                        // LiveKit-based connection
                        log('üé¨ LiveKit session created! Loading video SDK...');
                        await connectLiveKit(data.url, data.access_token, token);
                    } else if (data.sdp) {
                        // Legacy WebRTC SDP
                        await connectWebRTC(data.sdp, data.ice_servers2 || data.ice_servers, token);
                    } else {
                        throw new Error('Unknown session format: ' + JSON.stringify(Object.keys(data)));
                    }

                } catch (e) {
                    log('‚ùå Failed');
                    err(e.message || String(e));
                    startBtn.classList.remove('disabled');
                    console.error('Full error:', e);
                }
            }

            async function connectLiveKit(url, accessToken, sessionToken) {
                // Load LiveKit SDK dynamically
                log('üì¶ Loading LiveKit SDK...');
                var script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/livekit-client@2/dist/livekit-client.umd.js';

                await new Promise(function(resolve, reject) {
                    script.onload = resolve;
                    script.onerror = function() { reject(new Error('Failed to load LiveKit SDK')); };
                    document.head.appendChild(script);
                });

                log('üé¨ Connecting to video room...');
                var room = new LivekitClient.Room();

                room.on(LivekitClient.RoomEvent.TrackSubscribed, function(track, publication, participant) {
                    console.log('Track subscribed:', track.kind);
                    if (track.kind === 'video') {
                        var el = track.attach();
                        el.id = 'avatar-video';
                        el.style.width = '100%';
                        el.style.display = 'block';
                        var container = document.getElementById('video-container');
                        container.innerHTML = '';
                        container.appendChild(el);
                        container.style.display = 'block';
                        document.getElementById('controls').style.display = 'flex';
                        log('‚úÖ Connected! Type a message or start voice üëã');
                    }
                    if (track.kind === 'audio') {
                        var audioEl = track.attach();
                        document.body.appendChild(audioEl);
                    }
                });

                room.on(LivekitClient.RoomEvent.Disconnected, function() { log('Disconnected'); });

                await room.connect(url, accessToken);
                log('‚è≥ Waiting for avatar video...');

                // Store for later use
                window._heygenRoom = room;
                window._heygenToken = sessionToken;
                window._heygenSessionId = sessionId;
            }

            async function connectWebRTC(sdp, iceServers, sessionToken) {
                var config = { iceServers: iceServers || [{ urls: 'stun:stun.l.google.com:19302' }] };
                peerConnection = new RTCPeerConnection(config);

                peerConnection.ontrack = function(event) {
                    console.log('Got track:', event.track.kind);
                    if (event.track.kind === 'video') {
                        var vid = document.getElementById('avatar-video');
                        vid.srcObject = event.streams[0];
                        vid.play().catch(function(e) { console.log('play error:', e); });
                        document.getElementById('video-container').style.display = 'block';
                        document.getElementById('controls').style.display = 'flex';
                        log('‚úÖ Connected! Type a message or start voice üëã');
                    }
                };

                await peerConnection.setRemoteDescription(new RTCSessionDescription(sdp));
                var answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);

                // Send answer back
                await fetch('https://api.heygen.com/v1/streaming.start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + sessionToken
                    },
                    body: JSON.stringify({ session_id: sessionId, sdp: answer })
                });

                log('‚è≥ Waiting for video...');
            }

            // ---- SEND TEXT ----
            document.getElementById('send-btn').addEventListener('click', function() {
                var text = document.getElementById('chat-input').value.trim();
                if (!text || !window._heygenSessionId) return;
                document.getElementById('chat-input').value = '';
                log('üí¨ ' + text.substring(0, 40));

                fetch('https://api.heygen.com/v1/streaming.task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + window._heygenToken
                    },
                    body: JSON.stringify({
                        session_id: window._heygenSessionId,
                        text: text,
                        task_type: 'talk'
                    })
                }).then(function(r) { return r.json(); }).then(function(d) {
                    console.log('Task response:', d);
                }).catch(function(e) { err(e.message); });
            });

            document.getElementById('chat-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') document.getElementById('send-btn').click();
            });

            // ---- END ----
            document.getElementById('end-btn').addEventListener('click', function() {
                if (window._heygenRoom) {
                    window._heygenRoom.disconnect();
                    window._heygenRoom = null;
                }
                if (peerConnection) { peerConnection.close(); peerConnection = null; }

                if (window._heygenSessionId && window._heygenToken) {
                    fetch('https://api.heygen.com/v1/streaming.stop', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + window._heygenToken
                        },
                        body: JSON.stringify({ session_id: window._heygenSessionId })
                    }).catch(function() {});
                }

                document.getElementById('video-container').style.display = 'none';
                document.getElementById('controls').style.display = 'none';
                startBtn.classList.remove('disabled');
                sessionId = null;
                log('üì± Date ended!');
            });

            // Voice button placeholder
            document.getElementById('voice-btn').addEventListener('click', function() {
                err('Voice requires mic access ‚Äî use Send text for now');
            });

            console.log('[heygen] Page ready ‚úÖ');
        })();
    </script>
</body>
</html>
